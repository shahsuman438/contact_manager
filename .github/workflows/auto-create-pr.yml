name: Auto-Create PR with Summary

on:
  push:
    branches:
      - "feature/*"  # Runs when pushing to feature branches

jobs:
  auto-create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # âœ… Allows PR creation
      pull-requests: write  # âœ… Allows writing to PRs
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get Code Diff
        run: |
          git fetch origin main --depth=1
          git diff origin/main HEAD > code_diff.txt

      - name: Run Python Script to Generate Summary
        run: python summarize_pr.py

      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}  # âœ… Use PAT instead of default token
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          PR_TITLE="ðŸš€ Feature: ${BRANCH_NAME}"
          SUMMARY=$(cat pr_summary.txt)
          BODY="### PR Summary\n\n$SUMMARY"

          # Check if PR already exists
          PR_EXISTS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
                            -H "Accept: application/vnd.github.v3+json" \
                            "https://api.github.com/repos/${{ github.repository }}/pulls?head=${{ github.actor }}:$BRANCH_NAME&base=main" \
                            | jq '. | length')

          if [ "$PR_EXISTS" -eq "0" ]; then
            # Create a new PR
            PR_RESPONSE=$(curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/pulls" \
              -d "$(jq -n --arg title "$PR_TITLE" --arg body "$BODY" --arg head "${{ github.actor }}:$BRANCH_NAME" --arg base "main" '{title: $title, body: $body, head: $head, base: $base}')")

            echo "$PR_RESPONSE" | jq .
          else
            echo "PR already exists for branch $BRANCH_NAME. Skipping creation."
          fi
